<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strikegy — Lobby</title>
  <link rel="stylesheet" href="./assets/ui/shell.css" />
</head>
<body class="sg">
  <div class="sg-bg" aria-hidden="true"></div>

  <div class="sg-audioHint" id="audioHint">클릭해서 사운드 활성화</div>

  <div class="sg-shell">
    <header class="sg-top">
      <div class="sg-brand">STRIKEGY <span class="sg-tag">P4 · PRE2</span></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <span class="sg-chip" id="modeChip">MODE: <b id="selectedModeLabel">zone</b></span>
        <span class="sg-chip">AUDIO: <b id="audioState">ON</b></span>
      </div>
    </header>

    <main class="sg-main">
      <nav class="sg-nav" aria-label="메인 메뉴">
        <div class="sg-navHead">
          <div class="hint">↑↓ 이동 · Enter 선택</div>
          <div class="hint">ESC: 닫기</div>
        </div>
        <div class="sg-navList" id="navList">
          <button class="sg-item" data-action="campaign" data-hero="campaign" type="button">
            <div>
              <div class="label">캠페인</div>
              <div class="sub">싱글 플레이 · 챕터 진행</div>
            </div>
            <div class="meta">PLAY</div>
          </button>

          <div class="sg-groupLabel">SINGLEPLAYER</div>

          <button class="sg-item" data-action="mode" data-mode="zone" data-hero="lobby" type="button">
            <div>
              <div class="label">Zone Control</div>
              <div class="sub">거점 점령으로 전선 압박</div>
            </div>
            <div class="meta">ZONE</div>
          </button>

          <button class="sg-item" data-action="mode" data-mode="conquest" data-hero="lobby" type="button">
            <div>
              <div class="label">Conquest</div>
              <div class="sub">티켓·점령·시간 싸움</div>
            </div>
            <div class="meta">CONQ</div>
          </button>

          <button class="sg-item" data-action="mode" data-mode="frontline" data-hero="lobby" type="button">
            <div>
              <div class="label">Frontline</div>
              <div class="sub">최전선 유지/후퇴</div>
            </div>
            <div class="meta">FRONT</div>
          </button>

          
          <div class="sg-groupLabel">MULTIPLAYER</div>

          <button class="sg-item" data-action="multiplayer" data-hero="multiplayer" type="button">
            <div>
              <div class="label">Online Multiplayer</div>
              <div class="sub">Firebase 로비/룸 · WS 전투 (베타)</div>
            </div>
            <div class="meta">BETA</div>
          </button>

<div class="sg-groupLabel">SYSTEM</div>

          <button class="sg-item" data-action="settings" data-hero="lobby" type="button">
            <div>
              <div class="label">설정</div>
              <div class="sub">조작·감도·봇·BGM</div>
            </div>
            <div class="meta">OPT</div>
          </button>

          <button class="sg-item" data-action="help" data-hero="lobby" type="button">
            <div>
              <div class="label">도움말</div>
              <div class="sub">조작법·규칙 요약</div>
            </div>
            <div class="meta">INFO</div>
          </button>

          <button class="sg-item" data-action="credits" data-hero="lobby" type="button">
            <div>
              <div class="label">크레딧</div>
              <div class="sub">제작/라이선스 정보</div>
            </div>
            <div class="meta">BY</div>
          </button>
        </div>
      </nav>

      <section class="sg-right">
        <div class="sg-hero" id="hero">
          <div class="sg-heroContent">
            <div class="sg-heroTitle" id="heroTitle">STRIKEGY</div>
            <div class="sg-heroDesc" id="heroDesc">배틀필드식 UI + CoD식 톤을 섞은 새로운 로비 셸.</div>
            <div class="sg-heroMeta" id="heroMeta">
              <span class="sg-chip">Patch 4.0 Pre2</span>
              <span class="sg-chip">Autoplay BGM: Lobby.mp3</span>
              <span class="sg-chip">Keyboard + Mouse</span>
            </div>
          </div>
        </div>

        <div class="sg-panels">
          <div class="sg-panel">
            <div class="sg-panelTitle">STATUS</div>
            <div class="sg-panelBody" id="statusText">
              캠페인 진행도: <b id="campStatus">-</b><br>
              마지막 선택 모드: <b id="modeStatus">-</b>
            </div>
          </div>
          <div class="sg-panel">
            <div class="sg-panelTitle">PATCH NOTE</div>
            <div class="sg-panelBody">
              <b>Pre2</b>: 로비/캠페인 메뉴 UI 리마스터(셸), 배경 이미지 슬롯, 즉시 BGM 시도(차단 시 첫 입력에서 재시도).<br>
              * 배경 이미지는 <b>assets/ui/bg/</b>에 넣으면 자동 적용됩니다.
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="sg-status">
      <div>Tip: Enter로 선택 · 마우스로 바로 클릭도 가능</div>
      <div>selectedMode = <b>localStorage.selectedMode</b></div>
    </footer>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="sg-overlay" id="settingsOverlay" aria-hidden="true">
    <div class="sg-modal" role="dialog" aria-modal="true" aria-label="설정">
      <div class="sg-modalHeader">
        <div class="title">SETTINGS</div>
        <button class="sg-iconBtn" id="settingsCloseBtn" type="button">✕</button>
      </div>
      <div class="sg-modalBody">
        <div class="sg-field">
          <div class="sg-fieldTitle"><b>BGM</b><span>Lobby.mp3</span></div>
          <div class="sg-row" style="margin-top:10px">
            <label style="display:flex;gap:10px;align-items:center;">
              <input id="bgmEnabled" type="checkbox" checked />
              <span>Enable</span>
            </label>
            <div style="display:flex;gap:10px;align-items:center;min-width:220px;flex:1;">
              <input id="bgmVolumeRange" type="range" min="0" max="1" step="0.01" style="width:100%" />
              <b id="bgmVolumeValue" style="min-width:48px;text-align:right">35%</b>
            </div>
          </div>
        </div>

        <div class="sg-field">
          <div class="sg-fieldTitle"><b>조작 프리셋</b><span>로비 저장값</span></div>
          <div style="display:grid;gap:10px;margin-top:10px">
            <label><input type="radio" name="controlPreset" value="pc" checked /> PC</label>
            <label><input type="radio" name="controlPreset" value="mobile" /> Mobile</label>
            <label><input type="radio" name="controlPreset" value="mobile_kb" /> Mobile + Keyboard</label>
          </div>
        </div>

        <div class="sg-field">
          <div class="sg-fieldTitle"><b>마우스 감도</b><span id="sensitivityValue">1.00</span></div>
          <input class="sg-input" id="sensitivityRange" type="range" min="0.2" max="3.0" step="0.01" />
        </div>

        <div class="sg-field">
          <div class="sg-fieldTitle"><b>봇 난이도</b><span>싱글/테스트</span></div>
          <select class="sg-select" id="botDifficultySelect">
            <option value="very_easy">very_easy</option>
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
            <option value="expert">expert</option>
            <option value="nightmare">nightmare</option>
          </select>
        </div>

        <div class="sg-row" style="justify-content:flex-end;">
          <button class="sg-btn" id="settingsResetBtn" type="button">Reset</button>
          <button class="sg-btn primary" id="settingsSaveBtn" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HELP MODAL -->
  <div class="sg-overlay" id="helpOverlay" aria-hidden="true">
    <div class="sg-modal" role="dialog" aria-modal="true" aria-label="도움말">
      <div class="sg-modalHeader">
        <div class="title">HELP</div>
        <button class="sg-iconBtn" id="helpCloseBtn" type="button">✕</button>
      </div>
      <div class="sg-modalBody">
        <div class="sg-field">
          <div class="sg-fieldTitle"><b>PC 조작</b><span>기본</span></div>
          <div style="color:rgba(234,240,255,.72);font-size:13px;line-height:1.7;margin-top:10px">
            이동: <b>WASD</b> · 점프: <b>Space</b> · 달리기(홀드): <b>Shift</b> · 앉기(토글): <b>X</b> · 슬라이드: <b>달리기 중 X</b><br>
            발사: <b>좌클릭</b> · 조준: <b>우클릭</b> · 재장전: <b>R</b> · 무기/장비: <b>I</b> · 근접: <b>F</b>
          </div>
        </div>
        <div class="sg-field">
          <div class="sg-fieldTitle"><b>모드 요약</b><span>Patch 11 룰 기반</span></div>
          <div style="color:rgba(234,240,255,.72);font-size:13px;line-height:1.7;margin-top:10px">
            <b>Zone Control</b>: 거점을 점령해 전선을 만든다 (점령/중립화 진행).<br>
            <b>Conquest</b>: 거점을 점령해 티켓을 깎는다.<br>
            <b>Frontline</b>: 전선을 밀고 당기며 점령을 유지한다.<br>
            리스폰 대기시간: <b>5초</b>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CREDITS MODAL -->
  <div class="sg-overlay" id="creditsOverlay" aria-hidden="true">
    <div class="sg-modal" role="dialog" aria-modal="true" aria-label="크레딧">
      <div class="sg-modalHeader">
        <div class="title">CREDITS</div>
        <button class="sg-iconBtn" id="creditsCloseBtn" type="button">✕</button>
      </div>
      <div class="sg-modalBody">
        <div class="sg-field">
          <div class="sg-fieldTitle"><b>Strikegy</b><span>Web FPS Prototype</span></div>
          <div style="color:rgba(234,240,255,.72);font-size:13px;line-height:1.7;margin-top:10px">
            제작: Strikegy Dev (User) + ChatGPT 협업<br>
            BGM: AI 생성 음원 (Lobby/Briefing/Sneaking/Engaging)<br>
            엔진: three.js 기반(프로젝트 내 모듈)
          </div>
        </div>
        <div class="sg-field">
          <div class="sg-fieldTitle"><b>이미지</b><span>AI 생성</span></div>
          <div style="color:rgba(234,240,255,.72);font-size:13px;line-height:1.7;margin-top:10px">
            로비/캠페인 표지 이미지는 <b>assets/ui/bg/</b>에 추가하면 자동으로 적용됩니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import ClassSelectModal from "./src/ui/ClassSelectModal.js";
    import { CLASS_KEY, normalizeClassId } from "./src/data/classes.js";
    import { initLobbyBGM } from "./src/audio/LobbyBGM.js";
    import { CampaignDB, CAMPAIGN_KEY } from "./src/campaign/CampaignData.js";

    const MODE_KEY = "selectedMode";
    const DEFAULT_MODE = "zone";

    const $ = (s) => document.querySelector(s);

    // Elements
    const navList = $("#navList");
    const items = Array.from(navList.querySelectorAll(".sg-item"));
    const selectedModeLabel = $("#selectedModeLabel");
    const modeStatus = $("#modeStatus");
    const campStatus = $("#campStatus");

    const heroTitle = $("#heroTitle");
    const heroDesc = $("#heroDesc");

    const audioHint = $("#audioHint");
    const audioState = $("#audioState");

    // Modals
    const settingsOverlay = $("#settingsOverlay");
    const helpOverlay = $("#helpOverlay");
    const creditsOverlay = $("#creditsOverlay");

    // Settings inputs
    const bgmEnabledEl = $("#bgmEnabled");
    const bgmVolumeEl = $("#bgmVolumeRange");
    const bgmVolumeValueEl = $("#bgmVolumeValue");

    const sensitivityRange = $("#sensitivityRange");
    const sensitivityValue = $("#sensitivityValue");
    const botDifficultySelect = $("#botDifficultySelect");

    const SETTINGS_KEY = "strikegy_settings";
    const DEFAULT_SETTINGS = { controlPreset: "pc", sensitivity: 1.0, botDifficulty: "normal" };

    function clamp(n, min, max){
      n = Number(n);
      if(Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if(!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        const cp = (parsed.controlPreset === "pc" || parsed.controlPreset === "mobile" || parsed.controlPreset === "mobile_kb")
          ? parsed.controlPreset : DEFAULT_SETTINGS.controlPreset;
        const sens = clamp(Number(parsed.sensitivity ?? DEFAULT_SETTINGS.sensitivity), 0.2, 3.0);
        const bdRaw = String(parsed.botDifficulty ?? DEFAULT_SETTINGS.botDifficulty).toLowerCase();
        const bdAllowed = ["very_easy","easy","normal","hard","expert","nightmare"];
        const bd = bdAllowed.includes(bdRaw) ? bdRaw : DEFAULT_SETTINGS.botDifficulty;
        return { controlPreset: cp, sensitivity: sens, botDifficulty: bd };
      }catch{ return { ...DEFAULT_SETTINGS }; }
    }

    function saveSettings(s){
      try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }catch{}
    }

    function setRadio(name, value){
      document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.checked = (r.value === value));
    }

    function getRadio(name){
      const c = document.querySelector(`input[name="${name}"]:checked`);
      return c ? c.value : null;
    }

    function syncSettingsToForm(s){
      setRadio("controlPreset", s.controlPreset);
      sensitivityRange.value = String(s.sensitivity);
      sensitivityValue.textContent = Number(s.sensitivity).toFixed(2);
      botDifficultySelect.value = s.botDifficulty;
    }

    function readSettingsFromForm(){
      const cp = getRadio("controlPreset") || DEFAULT_SETTINGS.controlPreset;
      const sens = clamp(sensitivityRange.value, 0.2, 3.0);
      const bd = String(botDifficultySelect.value || DEFAULT_SETTINGS.botDifficulty);
      return { controlPreset: cp, sensitivity: sens, botDifficulty: bd };
    }

    function openOverlay(el){
      if(!el) return;
      el.classList.add("open");
      el.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeOverlay(el){
      if(!el) return;
      el.classList.remove("open");
      el.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    // Close buttons
    $("#settingsCloseBtn").addEventListener("click", ()=>closeOverlay(settingsOverlay));
    $("#helpCloseBtn").addEventListener("click", ()=>closeOverlay(helpOverlay));
    $("#creditsCloseBtn").addEventListener("click", ()=>closeOverlay(creditsOverlay));

    // Click outside modal closes
    [settingsOverlay, helpOverlay, creditsOverlay].forEach(ov => {
      ov.addEventListener("click", (e)=>{ if(e.target === ov) closeOverlay(ov); });
    });

    // ESC closes
    window.addEventListener("keydown", (e)=>{
      if(e.key !== "Escape") return;
      if(settingsOverlay.classList.contains("open")) return closeOverlay(settingsOverlay);
      if(helpOverlay.classList.contains("open")) return closeOverlay(helpOverlay);
      if(creditsOverlay.classList.contains("open")) return closeOverlay(creditsOverlay);
    });

    // Settings save/reset
    $("#settingsResetBtn").addEventListener("click", ()=>{
      syncSettingsToForm({ ...DEFAULT_SETTINGS });
    });
    $("#settingsSaveBtn").addEventListener("click", ()=>{
      const s = readSettingsFromForm();
      saveSettings(s);
      closeOverlay(settingsOverlay);
    });

    sensitivityRange.addEventListener("input", ()=>{
      sensitivityValue.textContent = clamp(sensitivityRange.value, 0.2, 3.0).toFixed(2);
    });

    // BGM: try autoplay immediately; if blocked, show hint ONLY when blocked (A안)
    let hintVisible = false;
    function showHint(){
      if(hintVisible) return;
      hintVisible = true;
      audioHint.classList.add("show");
    }
    function hideHint(){
      if(!hintVisible) return;
      hintVisible = false;
      audioHint.classList.remove("show");
    }

    const bgm = initLobbyBGM({
      enabledEl: bgmEnabledEl,
      volumeEl: bgmVolumeEl,
      volumeValueEl: bgmVolumeValueEl,
      onAutoplayBlocked: showHint,
      onPlaying: hideHint,
    });

    // Audio state indicator (enabled only)
    function refreshAudioState(){
      audioState.textContent = bgm?.state?.enabled ? "ON" : "OFF";
    }
    refreshAudioState();
    bgmEnabledEl.addEventListener("change", refreshAudioState);

    // Mode persistence
    function getSelectedMode(){
      try{ return localStorage.getItem(MODE_KEY) || DEFAULT_MODE; }catch{ return DEFAULT_MODE; }
    }
    function setSelectedMode(mode){
      const v = (mode === "zone" || mode === "conquest" || mode === "frontline") ? mode : DEFAULT_MODE;
      try{ localStorage.setItem(MODE_KEY, v); }catch{}
      selectedModeLabel.textContent = v;
      modeStatus.textContent = v;
    }

    setSelectedMode(getSelectedMode());

    // Campaign progress summary
    function readCampaignSession(){
      try{ return JSON.parse(localStorage.getItem(CAMPAIGN_KEY) || "null"); }catch{ return null; }
    }
    function computeCampaignStatus(){
      const s = readCampaignSession();
      if(!s?.progress?.missionStates) return "NEW";
      const ms = Object.values(s.progress.missionStates);
      const cleared = ms.filter(x=>x?.cleared).length;
      const total = Object.keys(CampaignDB?.missions || {}).length;
      return `${cleared}/${total} cleared`;
    }
    try{ campStatus.textContent = computeCampaignStatus(); }catch{ campStatus.textContent = "-"; }

    // Class selection modal
    const classSelect = new ClassSelectModal({
      onConfirm: (classId)=>{
        const normalized = normalizeClassId(classId);
        try{ localStorage.setItem(CLASS_KEY, normalized); }catch{}
        window.location.href = "game.html";
      }
    });

    // Hero data
    const HERO = {
      campaign: {
        title: "CAMPAIGN",
        desc: "임무 브리핑과 체크포인트를 기반으로 진행되는 싱글 플레이.",
        heroVar: "--sg-campaign-image",
      },      multiplayer: {
        title: "MULTIPLAYER",
        desc: "온라인 로비/룸은 Firebase로 관리하고, 전투는 WebSocket으로 중계한다.",
        heroVar: "--sg-bg-image",
      },

      
      zone: {
        title: "ZONE CONTROL",
        desc: "거점 점령으로 전선을 만들고 유지한다.",
        heroVar: "--sg-bg-image",
      },
      conquest: {
        title: "CONQUEST",
        desc: "거점을 점령해 티켓을 깎고, 제한 시간 안에 승리한다.",
        heroVar: "--sg-bg-image",
      },
      frontline: {
        title: "FRONTLINE",
        desc: "최전선 유지/후퇴를 반복하며 승부를 만든다.",
        heroVar: "--sg-bg-image",
      },
      settings: {
        title: "SETTINGS",
        desc: "조작 프리셋, 감도, 봇 난이도, BGM을 설정한다.",
        heroVar: "--sg-bg-image",
      },
      help: {
        title: "HELP",
        desc: "조작법/규칙을 빠르게 확인한다.",
        heroVar: "--sg-bg-image",
      },
      credits: {
        title: "CREDITS",
        desc: "제작 정보와 리소스 구성을 확인한다.",
        heroVar: "--sg-bg-image",
      },
    };

    function setHero(key){
      const h = HERO[key] || HERO.zone;
      heroTitle.textContent = h.title;
      heroDesc.textContent = h.desc;
      const img = getComputedStyle(document.documentElement).getPropertyValue(h.heroVar).trim();
      if(img) document.documentElement.style.setProperty("--sg-hero-image", img);
    }

    // Keyboard nav focus
    let activeIndex = 0;
    function setActiveIndex(idx){
      activeIndex = Math.max(0, Math.min(items.length - 1, idx));
      items.forEach((it,i)=>it.classList.toggle("is-active", i === activeIndex));
      const it = items[activeIndex];
      const action = it.dataset.action;
      if(action === "mode") setHero(it.dataset.mode);
      else setHero(action);
      it.scrollIntoView({ block: "nearest" });
    }

    setActiveIndex(0);

    window.addEventListener("keydown", (e)=>{
      if(settingsOverlay.classList.contains("open") || helpOverlay.classList.contains("open") || creditsOverlay.classList.contains("open")) return;
      if(e.key === "ArrowDown"){ e.preventDefault(); setActiveIndex(activeIndex + 1); }
      if(e.key === "ArrowUp"){ e.preventDefault(); setActiveIndex(activeIndex - 1); }
      if(e.key === "Enter"){ e.preventDefault(); trigger(items[activeIndex]); }
    });

    function trigger(item){
      const action = item.dataset.action;
      if(action === "campaign"){
        window.location.href = "./campaign.html";
        return;
      }
      if(action === "multiplayer"){
        const mode = getSelectedMode();
        window.location.href = `multiplayer.html?m=${encodeURIComponent(mode)}`;
        return;
      }

      
      if(action === "mode"){
        const mode = item.dataset.mode;
        setSelectedMode(mode);
        classSelect.open();
        return;
      }
      if(action === "settings") return openOverlay(settingsOverlay);
      if(action === "help") return openOverlay(helpOverlay);
      if(action === "credits") return openOverlay(creditsOverlay);
    }

    navList.addEventListener("click", (e)=>{
      const it = e.target.closest(".sg-item");
      if(!it) return;
      const idx = items.indexOf(it);
      if(idx >= 0) setActiveIndex(idx);
      trigger(it);
    });

    // Initialize settings form with saved values
    syncSettingsToForm(loadSettings());

    // Default hero to selected mode
    setHero(getSelectedMode());
  </script>
</body>
</html>
